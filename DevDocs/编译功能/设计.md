# 编译功能

## 需求

- 自动检测 UE 项目文件
- 自动获取引擎安装路径
- 调用 UE 编译工具编译项目
- 实时显示编译日志

## 设计方案

### 项目检测

读取当前目录下的 `.uproject` 文件（JSON 格式）：

```json
{
  "FileVersion": 3,
  "EngineAssociation": "5.3",
  "Category": "",
  "Description": ""
}
```

- `EngineAssociation`: 引擎版本号

### 引擎路径获取

根据 `EngineAssociation` 类型分两种情况：

#### 版本号格式（如 `5.3`）

优先级顺序：

1. **Windows 注册表**
   - `HKEY_LOCAL_MACHINE\SOFTWARE\EpicGames\Unreal Engine\{版本}`
   - `HKEY_CURRENT_USER\SOFTWARE\EpicGames\Unreal Engine\{版本}`
   - 键值: `InstalledDirectory`

2. **Epic Games Launcher 配置**
   - `%PROGRAMDATA%\Epic\UnrealEngineLauncher\LauncherInstalled.dat`
   - `%LOCALAPPDATA%\EpicGamesLauncher\Saved\Config\Windows\LauncherInstalled.dat`

#### GUID 格式（源码编译引擎）

当 `EngineAssociation` 为 GUID（如 `{XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX}`）时：

- **注册表路径**: `HKEY_CURRENT_USER\SOFTWARE\Epic Games\Unreal Engine\Builds`
- **键值**: GUID 字符串 → 引擎根目录路径

### 编译命令

```bash
Engine/Build/BatchFiles/Build.bat {项目名}Editor Win64 Development -Project="{项目路径}" -WaitMutex -FromMsBuild
```

## 任务清单

- [x] 数据层：项目信息读取
- [x] 数据层：引擎路径获取（注册表）
- [x] 数据层：引擎路径获取（Launcher 配置）
- [x] 数据层：GUID 引擎版本支持
- [x] 数据层：配置文件管理
- [x] 逻辑层：编译管理器
- [x] 逻辑层：编译进程清理
- [x] UI 层：主窗口
- [x] UI 层：日志显示
- [x] UI 层：窗口关闭处理

## 讨论记录

### 2025-01-16

- 确定使用 Python + tkinter 实现 GUI
- 三层架构：UI / Logic / Data
- 优先支持 Windows，后续考虑跨平台

## 边界问题与解决方案

| 问题 | 解决方案 |
|------|----------|
| 引擎路径找不到 | 按优先级尝试注册表、Launcher 配置 |
| 源码编译引擎（GUID） | 从 `HKCU\SOFTWARE\Epic Games\Unreal Engine\Builds` 获取 |
| UE4/UE5 编辑器名不同 | 先检测 UnrealEditor.exe，不存在则用 UE4Editor.exe |
| 编译输出乱码 | subprocess 使用 `encoding='gbk', errors='replace'` |
| 窗口关闭时编译进程残留 | OnClose 时调用 StopBuild 终止进程 |
| PyInstaller GUI 模式临时目录无法清理 | 使用 `console=True` + 启动时隐藏控制台窗口 |

## 废弃方案

| 方案 | 废弃原因 |
|------|----------|
| 纯批处理脚本 | 无法显示 GUI，跨平台困难 |
